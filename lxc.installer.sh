#! /bin/bash
# Programming and idea by : Iman Homayouni
# Gitbub : https://github.com/iman-homayouni
# Email : homayouni.iman@Gmail.com
# Website : http://www.homayouni.info
# License : GPL v2.0
# Last update : 11-March-2021_19:53:05
# lxc.installer v1.0.1
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #
# SUCCESSFULLY TESTED IN DEBIAN 10.X [BUSTER]
# SUCCESSFULLY TESTED IN UBUNTU 18.04 [BIONIC]
# SUCCESSFULLY TESTED IN UBUNTU 16.04 [XENIAL]
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #



function pre {
    # FORCE TO USE IPV4 IN APT # -------------------------------------------------------------------------------------------------------------------------- #
    echo -e 'Acquire::ForceIPv4 "true";' > /etc/apt/apt.conf.d/99force-ipv4
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #


    # UPDATE AND UPGRADE SYSTEM # ------------------------------------------------------------------------------------------------------------------------- #
    apt-get update
    apt-get -y dist-upgrade
    apt -y autoremove
    apt-get -y -f install
    apt-get clean
    apt-get install -y lsb-release &> /dev/null
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #
}



function source_focal {
    # INSTALL PRE PACKAGES # ------------------------------------------------------------------------------------------------------------------------------ #
    apt-get install -y make git
    apt-get install -y libtool m4 automake pkg-config
    apt-get install -y libvirt0 libpam-cgfs bridge-utils uidmap
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #


    # GIT CLONE PROJECT # --------------------------------------------------------------------------------------------------------------------------------- #
    cd /tmp/
    rm -rf lxc &> /dev/null
    git clone https://github.com/lxc/lxc.git -b stable-$q.0
    [ ! -d lxc ] && echo "[>] cannot access 'lxc': No such file or directory" && exit 1
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #


    # CHANGE DIRECTORY # ---------------------------------------------------------------------------------------------------------------------------------- #
    cd lxc
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #


    # RUN autogen.sh SCRIPT # ----------------------------------------------------------------------------------------------------------------------------- #
    ./autogen.sh
    [ "$?" != "0" ] && echo "[>] ERROR IN autogen.sh" && exit 1
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #


    # RUN configure SCRIPT # ------------------------------------------------------------------------------------------------------------------------------ #
    ./configure
    [ "$?" != "0" ] && echo "[>] ERROR IN configure" && exit 1
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #


    # RUN MAKE COMMAND # ---------------------------------------------------------------------------------------------------------------------------------- #
    make
    [ "$?" != "0" ] && echo "[>] ERROR IN make" && exit 1
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #


    # RUN MAKE INSTALL COMMAND # -------------------------------------------------------------------------------------------------------------------------- #
    make install
    [ "$?" != "0" ] && echo "[>] ERROR IN make install" && exit 1
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #


    # CLEAN UP TERMINAL # --------------------------------------------------------------------------------------------------------------------------------- #
    clear
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #


    # SHOW LXC VERSION # ---------------------------------------------------------------------------------------------------------------------------------- #
    echo -en "[>] LXC VERSION : "
    lxc-ls --version
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #
}



function source_bionic {
    # INSTALL PRE PACKAGES # ------------------------------------------------------------------------------------------------------------------------------ #
    apt-get install -y make git
    apt-get install -y libtool m4 automake pkg-config
    apt-get install -y libvirt0 libpam-cgfs bridge-utils uidmap
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #


    # GIT CLONE PROJECT # --------------------------------------------------------------------------------------------------------------------------------- #
    cd /tmp/
    rm -rf lxc &> /dev/null
    git clone https://github.com/lxc/lxc.git -b stable-$q.0
    [ ! -d lxc ] && echo "[>] cannot access 'lxc': No such file or directory" && exit 1
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #


    # CHANGE DIRECTORY # ---------------------------------------------------------------------------------------------------------------------------------- #
    cd lxc
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #


    # RUN autogen.sh SCRIPT # ----------------------------------------------------------------------------------------------------------------------------- #
    ./autogen.sh
    [ "$?" != "0" ] && echo "[>] ERROR IN autogen.sh" && exit 1
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #


    # RUN configure SCRIPT # ------------------------------------------------------------------------------------------------------------------------------ #
    ./configure
    [ "$?" != "0" ] && echo "[>] ERROR IN configure" && exit 1
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #


    # RUN MAKE COMMAND # ---------------------------------------------------------------------------------------------------------------------------------- #
    make
    [ "$?" != "0" ] && echo "[>] ERROR IN make" && exit 1
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #


    # RUN MAKE INSTALL COMMAND # -------------------------------------------------------------------------------------------------------------------------- #
    make install
    [ "$?" != "0" ] && echo "[>] ERROR IN make install" && exit 1
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #


    # CLEAN UP TERMINAL # --------------------------------------------------------------------------------------------------------------------------------- #
    clear
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #


    # SHOW LXC VERSION # ---------------------------------------------------------------------------------------------------------------------------------- #
    echo -en "[>] LXC VERSION : "
    lxc-ls --version
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #
}



function repo_xenial_2 {
    # CHECK lsb_release # --------------------------------------------------------------------------------------------------------------------------------- #
    which lsb_release &> /dev/null
    [ "$?" != "0" ] && echo -e "[>] WE CAN NOT FIND lsb_release" && exit !
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #


    # CHECK OS CODENAME # --------------------------------------------------------------------------------------------------------------------------------- #
    [ "$(lsb_release -cs)" != "xenial" ] && echo -e "[>] OS CODENAME IS NOT XENIAL" && exit 1
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #


    # INSTALL MAIN PACKAGE FROM REPOSITORY # -------------------------------------------------------------------------------------------------------------- #
    apt-get install -y lxc lxc-templates
    apt-get install -y libvirt0 libpam-cgfs bridge-utils uidmap
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #


    # CLEAN UP TERMINAL # --------------------------------------------------------------------------------------------------------------------------------- #
    clear
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #


    # SHOW LXC VERSION # ---------------------------------------------------------------------------------------------------------------------------------- #
    echo -en "[>] LXC VERSION : "
    lxc-ls --version
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #
}



function repo_xenial_3 {
    # CHECK lsb_release # --------------------------------------------------------------------------------------------------------------------------------- #
    which lsb_release &> /dev/null
    [ "$?" != "0" ] && echo -e "[>] WE CAN NOT FIND lsb_release" && exit !
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #


    # CHECK OS CODENAME # --------------------------------------------------------------------------------------------------------------------------------- #
    [ "$(lsb_release -cs)" != "xenial" ] && echo -e "[>] OS CODENAME IS NOT XENIAL" && exit 1
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #


    # PRINT MSG TO TERMINAL # ----------------------------------------------------------------------------------------------------------------------------- #
    echo -e "\e[91m[>] PLEASE TAKE A SNAPSHOT FROM YOUR SYSTEM"
    echo -e "[>] WE NEED TO INSTALL SOME PACKAGES FROM XENIAL BACKPORT REPO\e[0m"
    echo -en "[>] ARE YOU SURE ? [Y/N] : " ; read q
    [ "$q" != "Y" ] && exit 1
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #


    # CHECK BACKPORT REPO # ------------------------------------------------------------------------------------------------------------------------------- #
    cat /etc/apt/sources.list | grep backports &> /dev/null
    if [ "$?" != "0" ] ; then
        # FIND MAIN REPO URL # ---------------------------------------------------------------------------------------------------------------------------- #
        repo_url=$(cat /etc/apt/sources.list /etc/apt/sources.list.d/* 2> /dev/null | grep -v '#' | grep 'xenial ' \
        | head -n 1 | grep -Eo "(http|https)://[a-zA-Z0-9./?=_%:-]*")
        # ------------------------------------------------------------------------------------------------------------------------------------------------- #


        # ADD BACKPORT REPO TO SYSTEM # ------------------------------------------------------------------------------------------------------------------- #
        echo "deb [arch=amd64] $repo_url xenial-backports main restricted universe multiverse" >> /etc/apt/sources.list
        # ------------------------------------------------------------------------------------------------------------------------------------------------- #
    fi
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #


    for package in $(echo "lxc-utils liblxc1 lxc") ; do
        # FIND PACKAGE VERSION # -------------------------------------------------------------------------------------------------------------------------- #
        version=$(apt policy $package 2> /dev/null | grep 3.0 | tr -s ' ' | cut -d ' ' -f 2)
        # ------------------------------------------------------------------------------------------------------------------------------------------------- #


        # INSTALL PACKAGES # ------------------------------------------------------------------------------------------------------------------------------ #
        apt-get install -y $package="$version"
        # ------------------------------------------------------------------------------------------------------------------------------------------------- #
    done


    # INSTALL OTHER PACKAGES # ---------------------------------------------------------------------------------------------------------------------------- #
    apt-get install -y libvirt0 libpam-cgfs bridge-utils uidmap lxc-templates
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #


    # CLEAN UP TERMINAL # --------------------------------------------------------------------------------------------------------------------------------- #
    clear
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #


    # SHOW LXC VERSION # ---------------------------------------------------------------------------------------------------------------------------------- #
    echo -en "[>] LXC VERSION : "
    lxc-ls --version
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #
}



function repo_bionic_2 {
    # CHECK lsb_release # --------------------------------------------------------------------------------------------------------------------------------- #
    which lsb_release &> /dev/null
    [ "$?" != "0" ] && echo -e "[>] WE CAN NOT FIND lsb_release" && exit !
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #


    # CHECK OS CODENAME # --------------------------------------------------------------------------------------------------------------------------------- #
    [ "$(lsb_release -cs)" != "bionic" ] && echo -e "[>] OS CODENAME IS NOT BIONIC" && exit 1
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #


    # PRINT MSG TO TERMINAL # ----------------------------------------------------------------------------------------------------------------------------- #
    echo -e "\e[91m[>] PLEASE TAKE A SNAPSHOT FROM YOUR SYSTEM"
    echo -e "[>] WE NEED TO INSTALL SOME PACKAGES FROM XENIAL REPO\e[0m"
    echo -en "[>] ARE YOU SURE ? [Y/N] : " ; read q
    [ "$q" != "Y" ] && exit 1
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #


    # REMOVE SPECIFIC PACKAGES # -------------------------------------------------------------------------------------------------------------------------- #
    apt-get -y remove --purge lxcfs
    apt-get -y remove --purge liblxc1
    apt-get -y remove --purge python3
    apt-get -y remove --purge python3-minimal
    apt-get -y remove --purge libpython3-stdlib
    apt -y autoremove
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #


    # CHANGE SYSTEM REPO TO XENIAL # ---------------------------------------------------------------------------------------------------------------------- #
    sed -i 's/bionic/xenial/g' /etc/apt/sources.list
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #


    # INSTALL SPECIFIC PACKAGES # ------------------------------------------------------------------------------------------------------------------------- #
    apt-get update
    apt-get install -y liblxc1
    apt-get install -y python3-minimal
    apt-get install -y libpython3-stdlib
    apt-get install -y python3
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #


    # FIND AND DOWNLOAD perl-base_5.22.1-9ubuntu0.9_amd64.deb PACKAGE # ----------------------------------------------------------------------------------- #
    repo_url=$(cat /etc/apt/sources.list /etc/apt/sources.list.d/* 2> /dev/null | grep -v '#' | grep 'xenial ' \
    | head -n 1 | grep -Eo "(http|https)://[a-zA-Z0-9./?=_%:-]*")
    wget $repo_url/pool/main/p/perl/perl-base_5.22.1-9ubuntu0.9_amd64.deb
    [ "$?" != "0" ] && echo -e "[>] CAN NOT DOWNLOAD $repo_url/pool/main/p/perl/perl-base_5.22.1-9ubuntu0.9_amd64.deb" && exit 1
    dpkg -i perl-base_5.22.1-9ubuntu0.9_amd64.deb
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #


    # INSTALL SPECIFIC PACKAGES # ------------------------------------------------------------------------------------------------------------------------- #
    apt-get -y -f install
    apt-get install -y libapparmor-perl
    apt-get install -y lxc-common
    apt-get install -y liblxc1
    apt-get install -y lxcfs
    apt-get install -y lxc libvirt0 libpam-cgfs bridge-utils uidmap
    apt -y autoremove
    apt-get -y -f install
    apt-get clean
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #


    # CHANGE SYSTEM REPO TO XENIAL # ---------------------------------------------------------------------------------------------------------------------- #
    sed -i 's/xenial/bionic/g' /etc/apt/sources.list
    apt-get update
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #


    # DISABLE SPECIFIC PACKAGES FROM UPGRADE # ------------------------------------------------------------------------------------------------------------ #
    apt-mark hold apparmor cloud-image-utils debootstrap dh-python genisoimage libaio1 libapparmor-perl liblxc1 libnspr4 libnss3 libpython3-stdlib \
    librados2 librbd1 lxc lxc-templates lxc1 lxcfs perl-base python3 python3-lxc python3-minimal qemu-block-extra qemu-utils sharutils
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #


    # CLEANUP SHELL # ------------------------------------------------------------------------------------------------------------------------------------- #
    clear
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #


    # SHOW LXC VERSION # ---------------------------------------------------------------------------------------------------------------------------------- #
    echo -en "[>] LXC VERSION : "
    lxc-ls --version
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #
}



function repo_bionic_3 {
    # UNMARK SPECIFIC PACKAGES # -------------------------------------------------------------------------------------------------------------------------- #
    apt-mark unhold apparmor cloud-image-utils debootstrap dh-python genisoimage libaio1 libapparmor-perl liblxc1 libnspr4 libnss3 libpython3-stdlib \
    librados2 librbd1 lxc lxc-templates lxc1 lxcfs perl-base python3 python3-lxc python3-minimal qemu-block-extra qemu-utils sharutils &> /dev/null
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #


    # RUN PRE FUNCTION # ---------------------------------------------------------------------------------------------------------------------------------- #
    pre
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #


    # CHECK lsb_release # --------------------------------------------------------------------------------------------------------------------------------- #
    which lsb_release &> /dev/null
    [ "$?" != "0" ] && echo -e "[>] WE CAN NOT FIND lsb_release" && exit !
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #


    # CHECK OS CODENAME # --------------------------------------------------------------------------------------------------------------------------------- #
    [ "$(lsb_release -cs)" != "bionic" ] && echo -e "[>] OS CODENAME IS NOT BIONIC" && exit 1
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #


    # INSTALL MAIN PACKAGE FROM REPOSITORY # -------------------------------------------------------------------------------------------------------------- #
    apt-get install -y lxc lxc-templates
    apt-get install -y libvirt0 libpam-cgfs bridge-utils uidmap
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #


    # CLEAN UP TERMINAL # --------------------------------------------------------------------------------------------------------------------------------- #
    clear
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #


    # SHOW LXC VERSION # ---------------------------------------------------------------------------------------------------------------------------------- #
    echo -en "[>] LXC VERSION : "
    lxc-ls --version
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #
}



function snap_debian_10 {
    # INSTALL DEPENDENCIES # ------------------------------------------------------------------------------------------------------------------------------ #
    apt-get install -y snapd wget jq curl
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #

    for package in $(echo core core18 lxd) ; do
        # FIND SNAP PACKAGES # ---------------------------------------------------------------------------------------------------------------------------- #
        curl -s -H 'Snap-Device-Series: 16' http://api.snapcraft.io/v2/snaps/info/$package > /tmp/snap.json
        url=$(cat /tmp/snap.json | jq '.' | grep "architecture\|url" | grep amd64 -A 1 | grep url | cut -d '"' -f 4 | sort -Vu | head -n 1)
        # ------------------------------------------------------------------------------------------------------------------------------------------------- #


        # CREATE TEMP DIRECTORY # ------------------------------------------------------------------------------------------------------------------------- #
        mkdir /tmp/snap_files/
        # ------------------------------------------------------------------------------------------------------------------------------------------------- #


        # DOWNLOAD SNAP PACKAGES # ------------------------------------------------------------------------------------------------------------------------ #
        cd /tmp/snap_files
        echo -e "\e[93m[>] DOWNLOAD $url"
        wget "$url"
        [ "$?" != "0" ] && echo -e "[>] WE CANNOT DOWNLOAD $URL\e[0m" && exit 1
        echo -en "\e[0m"
        # ------------------------------------------------------------------------------------------------------------------------------------------------- #


        # INSTALL LXD FROM SNAP # ------------------------------------------------------------------------------------------------------------------------- #
        snap install --dangerous $(echo $url | rev | cut -d '/' -f 1 | rev)
        # ------------------------------------------------------------------------------------------------------------------------------------------------- #


        # REMOVE TEMP DIRECTORY # ------------------------------------------------------------------------------------------------------------------------- #
        rm -rf /tmp/snap_files &> /dev/null
        # ------------------------------------------------------------------------------------------------------------------------------------------------- #
    done

    # ADD PATH TO BASHRC # -------------------------------------------------------------------------------------------------------------------------------- #
    echo -e 'export PATH="$PATH:/snap/bin"' >> /root/.bashrc
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #


    # RELOAD BASHRC # ------------------------------------------------------------------------------------------------------------------------------------- #
    . /root/.bashrc
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #


    # CLEAN UP TERMINAL # --------------------------------------------------------------------------------------------------------------------------------- #
    clear
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #


    # SHOW LXC VERSION # ---------------------------------------------------------------------------------------------------------------------------------- #
    echo -en "[>] LXD VERSION : "
    lxd --version
    # ----------------------------------------------------------------------------------------------------------------------------------------------------- #
}



# PRINT MAIN MENU IN TERMINAL # --------------------------------------------------------------------------------------------------------------------------- #
echo -e "[>] INSTALL FROM SOURCE CODE:"
echo -e "[1] INSTALL LXC V4 FROM SOURCE CODE IN FOCAL"
echo -e "[2] INSTALL LXC V3 FROM SOURCE CODE IN BIONIC"
echo -e "[3] INSTALL LXC V3 FROM SOURCE CODE IN XENIAL"
echo -e "[>]"
echo -e "[>] INSTALL FROM REPOSITORY:"
echo -e "[4] INSTALL LXC V2.0.11 FROM REPOSITORY IN XENIAL"
echo -e "[5] INSTALL LXC V2.0.11 FROM REPOSITORY IN BIONIC"
echo -e "[6] INSTALL LXC V3.0.3 FROM REPOSITORY IN XENIAL"
echo -e "[7] INSTALL LXC V3.0.3 FROM REPOSITORY IN BIONIC"
echo -e "[>]"
echo -e "[>] INSTALL FROM SNAP:"
echo -e "[8] INSTALL LXD FROM SNAP IN DEBIAN 10"
echo -en "[?] WHICH ONE ? [1/2/3/4/5/6/7] : " ; read q
# --------------------------------------------------------------------------------------------------------------------------------------------------------- #


if [ "$q" = "1" ] ; then
    pre

elif [ "$q" = "2" ] ; then
    pre

elif [ "$q" = "3" ] ; then
    pre

elif [ "$q" = "4" ] ; then
    pre
    repo_xenial_2

elif [ "$q" = "5" ] ; then
    pre
    repo_bionic_2

elif [ "$q" = "6" ] ; then
    pre
    repo_xenial_3

elif [ "$q" = "7" ] ; then
    repo_bionic_3

elif [ "$q" = "8" ] ; then
    pre
    snap_debian_10
fi
